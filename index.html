<!DOCTYPE html>
<html>
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <title>Music Controller and FFT Display</title>
</head>
<body>

<h1>Music Controller and FFT Display</h1>
  <p><b>Team Members: </b> Annie Luo, Dimitry Jean-Laurent, Emmy Perez, Shyam Patel</p>
<h2>Project Description</h2>
  <p>For this project, we developed a music controller that consisted of a C# GUI and an mbed setup. In the GUI, the user can select a song from a library of options stored on the SD card and based upon this selection, a FFT analysis is performed on the .wav file and the output is displayed on an 8x8 LED display. For the display, we created 5 different outputs that would be shown based upon the frequency range that was outputted from the FFT analysis. In order to accomplish all of these parts at once, RTOS was used to thread each component. </p>
  <p><b>Click on the button to download a .zip of our project with the libraries used:</b><p>
  <a href="WiringDiagram.png" download>
    <img src="download.png" alt="W3Schools" width="175" height="75">
  </a>
  <h2>Libraries Used</h2>
  <ul>
    <li> mbed.h </li>
    <li> SDFileSystem.h </li>
    <li> wave_player.h </li>
    <li> Adafruit_LEDBackpack.h </li>
    <li> Adafruit_GFX.h </li>
    <li> rtos.h </li>
    <li> FFT.h </li>
  </ul>
<h2>Parts Used</h2>
  <ul>
    <li> Speaker </li>
    <li> H-Bridge Amplifier </li>
    <li> Potentiometer </li>
    <li> SD Card Reader </li>
    <li> Adafruit LuckyLight 8x8 LED Display </li>
    <li> mbed LPC1768 </li>
  </ul>
<h2>Wiring Diagram</h2>
  <img src="WiringDiagram.png" width="600" height="500" alt="hi">
<h2>C# GUI</h2>
  <p>In the GUI, you can choose the COM port for the SD card to read in the song library and select what song you would like to listen to. After making your selection, the GUI then displays the song name while the song is playing.</p>
  <pre> 
    <code> 
      using System;
      using System.Collections.Generic;
      using System.ComponentModel;
      using System.Data;
      using System.Drawing;
      using System.Linq;
      using System.Text;
      using System.Threading.Tasks;
      using System.Windows.Forms;
      using System.IO.Ports;
      using System.Diagnostics;

      namespace Final_Project_4180
      {
        public partial class Form1 : Form
        {
          private String[] portNames;
          private String[] songs = { "africa-toto", "around_the_world-atc", "beautiful_life-ace_of_base", "dont_speak-no_doubt", "my-love", "Song1_test" };
          private bool play = false;
          private String song = "";
      
          public Form1()
          {
            InitializeComponent();
          }

          private void comboBox1_SelectedValueChanged(object sender, EventArgs e)
          {
            serialPort1.PortName = comboBox1.Text;
          }

          private void Form1_Load(object sender, EventArgs e)
          {
            Debug.Print("hello 4180 project!");
            try
            {
                Debug.Print("init load");
                portNames = SerialPort.GetPortNames();
                comboBox1.Items.AddRange(portNames);
                comboBox1.SelectedIndex = 0;
                Debug.Print("end load");
            }
            catch (Exception err)
            {
                Debug.Print("loading error: " + err.Message);
            }
            Debug.Print("Connected Mbed to " + comboBox1.Text);


          }

          private void comboBox1_TextUpdate(object sender, EventArgs e)
          {
            if (serialPort1.IsOpen) serialPort1.Close();
            serialPort1.PortName = comboBox1.Text;
            serialPort1.Open();
          }

          private void Form1_FormClosed(object sender, FormClosedEventArgs e)
          {
            serialPort1.Close();
          }

          private void comboBox2_SelectedValueChanged(object sender, EventArgs e)
          {
            switch (comboBox2.SelectedItem.ToString())
            {
                case "Africa":
                    Debug.Print("africa-toto");
                    song = "!1";
                    break;
                case "Around the World":
                    Debug.Print("around_the_world-atc");
                    song = "!2";
                    break;
                case "Beautiful Life":
                    Debug.Print("beautiful_life-ace_of_base");
                    song = "!3";
                    break;
                case "Don't Speak":
                    Debug.Print("dont_speak-no_doubt");
                    song = "!4";
                    break;
                case "My Love":
                    Debug.Print("my-love");
                    song = "!5";
                    break;
                case "Song1_test":
                    Debug.Print("Song1_test");
                    song = "!6";
                    break;
                default:
                    break;
            }
            label3.Text = comboBox2.SelectedItem.ToString();
            if (serialPort1.IsOpen)
            {
                serialPort1.Write(song);
            }
            else
            {
                try
                {
                    serialPort1.Open();
                } catch (Exception err)
                {
                    Debug.Print("Error: " + err.Message);
                }
            }
          }

          private void button1_Click(object sender, EventArgs e)
          {
            play = !play;
            if (serialPort1.IsOpen)
            {
                if (play == true)
                {
                    serialPort1.Write("!P");
                }
                else
                {
                    serialPort1.Write("!S");
                }
            }
            else
            {
                try
                {
                    serialPort1.Open();
                } catch (Exception err)
                {
                    Debug.Print("Error: " + err.Message);
                }
            }
          }
        }
      }
    </code> 
  </pre>
<h2>mbed Setup and FFT</h2>
  <p>We have 2 threads in our program. One that that takes in data from the C# GUI and plays the music selection on the speaker and another that runs an FFT analysis on the music and then determines what frequency bin that the output falls into and displays it. In order to do the FFT analysis on the data we ran into some issues grabbing data in the form of an array from our .wav file in order to run this through the FFT library that we were using. To fix this issue, we had to first create an .txt file containing an array of values from the .wav file using the WAVToCode software and place this on our SD card. From there, we were able to sample the data and perform our calculations for the output.</p>
  <pre> 
    <code> 
      #include<stdio.h> 
      int main() { 
        printf("Hello Geeks"); 
      } 
    </code> 
  </pre>
<h2>Demonstration Video</h2>
  <iframe width="560" height="315" src="https://www.youtube.com/embed/Dd7FixvoKBw" frameborder="0" allowfullscreen></iframe>
</body>
</html>
